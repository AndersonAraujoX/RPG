<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sombra OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: #00ff41; /* Cor do texto do terminal */
            text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41;
            image-rendering: pixelated;
            overflow: hidden;
        }

        .vhs-wrapper {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .vhs-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.4) 0px, rgba(0,0,0,0.4) 1px, transparent 1px, transparent 2px);
            animation: vhs-scanlines 2s steps(4) infinite;
            pointer-events: none;
            z-index: 2;
        }
        
        .vhs-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            opacity: 0.1;
            z-index: -1;
            animation: vhs-flicker 0.15s infinite;
        }

        @keyframes vhs-scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(8px); }
        }
        
        @keyframes vhs-flicker {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.2; }
        }

        .content-glitch {
             animation: vhs-glitch 2.5s linear infinite alternate-reverse;
        }

        @keyframes vhs-glitch {
          2%,64% { transform: translate(1px,-1px) skew(0deg); }
          4%,60% { transform: translate(-1px,1px) skew(0deg); }
          62% { transform: translate(0,0) skew(2deg); }
        }
        
        .terminal {
            width: 100%;
            height: 100vh;
            padding: 2rem;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
        }
        .terminal::-webkit-scrollbar { 
            display: none;  /* Safari and Chrome */
        }
        
        #terminal-output p, #terminal-output div {
            white-space: pre-wrap;
            word-break: break-all;
        }

        .prompt-input {
            background: transparent;
            border: none;
            outline: none;
            color: #00ff41;
            text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41;
            width: 100%;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: #00ff41;
            animation: blink 1s step-end infinite;
            box-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41;
        }

        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff41; }
        }
    </style>
</head>
<body>

    <div class="vhs-wrapper">
        <div id="terminal" class="terminal content-glitch" onclick="initiateConnection()">
            <div id="terminal-output" class="text-sm md:text-base"></div>
            <div id="input-line" class="flex" style="display: none;">
                <span id="prompt-symbol" class="text-green-400">sombra@kuar-tor:~$</span>
                <input type="text" id="command-input" class="prompt-input flex-1 ml-2">
                <span class="cursor"></span>
            </div>
        </div>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminal-output');
        const inputField = document.getElementById('command-input');
        const inputLine = document.getElementById('input-line');
        const promptSymbol = document.getElementById('prompt-symbol');
        let isAudioStarted = false;
        let typeSound;

        // Filesystem com contexto da campanha Kuar-Tor
        const filesystem = {
            'leia-me.txt': 'AVISO: As informações contidas neste sistema são confidenciais. O acesso não autorizado será rastreado. A curiosidade é uma virtude, mas a discrição é uma arte.',
            'relatorio_faccoes.txt': `
RELATÓRIO DE INTELIGÊNCIA - FACÇÕES DE KUAR-TOR
-----------------------------------------------

- A Aliança: Conglomerado de guildas, reinos e repúblicas. Foco em comércio, diplomacia e defesa mútua. Atualmente lideram a exploração de Kuar-Tor.

- A Horda: Tribos e clãs de regiões selvagens. Valorizam força, honra e tradição. Relação complexa com a Aliança, alternando entre conflito e cooperação.

- Império do Sol Poente: Nação expansionista com poderio militar e tecnológico. Veem Kuar-Tor como uma fronteira a ser dominada e explorada.

- Culto do Vazio: Seita apocalíptica que venera o Vazio, uma força cósmica de aniquilação. Acreditam que Kuar-Tor é a chave para a chegada de sua entidade.

- As Três Famílias (Yang, Xang, Zhauw): Clãs poderosos com influência política e econômica massiva. Manipulam eventos por trás dos panos para manter seu poder.
            `,
            'dossie_anya.txt': `
DOSSIÊ CONFIDENCIAL - ALVO: GENERAL ANYA
-----------------------------------------

NOME: Anya, "A Estrategista de Ferro"
AFILIAÇÃO: Império do Sol Poente
CARGO: Comandante da Terceira Expedição para Kuar-Tor
PERFIL: Tática brilhante e líder implacável. Leal ao Império, mas possui um forte senso de honra pessoal. Não subestime sua capacidade de adaptação no campo de batalha. É conhecida por utilizar tanto tecnologia avançada quanto táticas de guerrilha.
OBSERVAÇÕES: A Terceira Expedição sob seu comando é a mais bem equipada até agora. Seus objetivos em Kuar-Tor parecem ir além da simples conquista territorial. Monitorar suas ações é prioridade máxima.
            `,
            'manual_hackeado.txt': `
SISTEMA +2D6 - GUIA RÁPIDO (VERSÃO PIRATA)
------------------------------------------

- TESTES: Role 2d6 e some o bônus do Atributo relevante. O alvo padrão é 8.
  - Sucesso: Resultado 8 ou mais.
  - Falha: Resultado 7 ou menos.

- TESTES OPOSTOS: Ambos os lados rolam 2d6 + Atributo. O maior resultado vence.

- CRÍTICOS:
  - Acerto Crítico (rolagem 12 nos dados): Sucesso excepcional. Causa dano máximo ou efeito ampliado.
  - Falha Crítica (rolagem 2 nos dados): Falha desastrosa. Algo muito ruim acontece.

- ATRIBUTOS CHAVE:
  - FOR (Força): Combate corpo a corpo, levantar peso.
  - DES (Destreza): Combate à distância, agilidade, furtividade.
  - CON (Constituição): Pontos de Vida, resistência a venenos/doenças.
  - INT (Inteligência): Conhecimento, tecnologia, investigação.
  - SAB (Sabedoria): Percepção, intuição, força de vontade.
  - CAR (Carisma): Liderança, persuasão, social.

>> Fim do arquivo. Este manual foi simplificado para acesso rápido em campo. <<
            `,
            'log_missao_eco.txt': `
LOG DE MISSÃO FRAGMENTADO - RECUPERADO
---------------------------------------
...dados corrompidos...
Entrada 3: A "Corrupção" não é uma praga, é uma consciência. Ela sussurra nas sombras, torce a realidade. Encontramos uma estrutura antiga, pulsando com a mesma energia sombria. Parece ser a fonte.

Entrada 5: A névoa escarlate está se espalhando a partir do epicentro. Criaturas que a respiram se tornam... outras coisas. Hostis. Deformadas. Ecos do que eram antes.

Entrada 7: O Guardião caiu. A energia o consumiu. Ele agora protege a fonte. Não podemos passar. O Vazio está mais perto... A equipe...
...dados corrompidos...
FIM DA TRANSMISSÃO
            `
        };

        // Command definitions
        const commands = {
            'help': {
                description: 'Exibe a lista de comandos disponíveis.',
                execute: () => {
                    const availableCommands = Object.keys(commands).map(cmd => `  ${cmd.padEnd(10)} - ${commands[cmd].description}`).join('\n');
                    return `Comandos disponíveis no Sombra OS:\n${availableCommands}`;
                }
            },
            'ls': {
                description: 'Lista os arquivos no diretório atual.',
                execute: () => {
                    return Object.keys(filesystem).join('   ');
                }
            },
            'cat': {
                description: 'Exibe o conteúdo de um arquivo. Uso: cat [arquivo]',
                execute: (args) => {
                    const fileName = args[0];
                    if (!fileName) {
                        return 'Uso: cat [arquivo]';
                    }
                    if (filesystem[fileName]) {
                        return filesystem[fileName];
                    }
                    return `cat: ${fileName}: Arquivo ou diretório não encontrado`;
                }
            },
            'whoami': {
                description: 'Exibe o nome do usuário atual.',
                execute: () => 'sombra'
            },
            'date': {
                description: 'Exibe a data e hora atuais.',
                execute: () => new Date().toLocaleString('pt-BR')
            },
            'echo': {
                description: 'Exibe uma linha de texto. Uso: echo [texto]',
                execute: (args) => args.join(' ')
            },
            'clear': {
                description: 'Limpa a tela do terminal.',
                execute: () => {
                    terminalOutput.innerHTML = '';
                    return ''; // No output for clear command
                }
            }
        };

        const bootSequence = [
            "Inicializando Sombra OS v1.1 (Kernel 6.8.0-kuartor)...",
            "Verificando memória... OK",
            "Montando sistema de arquivos criptografado... OK",
            "Iniciando serviços de rede furtiva...",
            "Conexão segura estabelecida com o servidor 'O Olho'.",
            " ",
            "Bem-vindo ao Sombra OS, Agente.",
            "Use 'ls' para ver os arquivos recuperados.",
            "Digite 'help' para a lista de comandos.",
        ];

        function focusInput() {
            inputField.focus();
        }

        async function typeWriter(text, element, speed = 20) {
            return new Promise(resolve => {
                let i = 0;
                function type() {
                    if (i < text.length) {
                        if (typeSound && text.charAt(i) !== ' ' && text.charAt(i) !== '\n') {
                           typeSound.triggerAttackRelease("C6", "0.05");
                        }
                        element.innerHTML += text.charAt(i);
                        i++;
                        terminal.scrollTop = terminal.scrollHeight;
                        setTimeout(type, speed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }
        
        async function typeWriterSilent(text, element, speed = 50) {
            return new Promise(resolve => {
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        terminal.scrollTop = terminal.scrollHeight;
                        setTimeout(type, speed);
                    } else {
                        resolve();
                    }
                }
                type();
            });
        }
        
        async function playDialUpSound() {
            return new Promise(async (resolve) => {
                const dialMsg = document.createElement('p');
                terminalOutput.appendChild(dialMsg);
                await typeWriter("ESTABELECENDO CONEXÃO SEGURA...", dialMsg, 50);

                const noise = new Tone.Noise("white").toDestination();
                const synth = new Tone.FMSynth({
                    harmonicity: 3, modulationIndex: 10,
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 },
                    modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 }
                }).toDestination();
                
                noise.volume.value = -20;

                const dtmf = (f1, f2) => {
                    const o1 = new Tone.Oscillator(f1, "sine").toDestination();
                    const o2 = new Tone.Oscillator(f2, "sine").toDestination();
                    o1.volume.value = -15; o2.volume.value = -15;
                    o1.start().stop("+0.15"); o2.start().stop("+0.15");
                };
                
                Tone.Transport.scheduleOnce(() => dtmf(697, 1209), "0.1");
                Tone.Transport.scheduleOnce(() => dtmf(770, 1336), "0.4");
                Tone.Transport.scheduleOnce(() => dtmf(852, 1477), "0.7");

                Tone.Transport.scheduleOnce(() => {
                    noise.start().stop("+2.5");
                    synth.triggerAttackRelease("C2", "0.2", Tone.now());
                    synth.frequency.rampTo("C4", 1, Tone.now() + 0.5);
                }, "1.0");

                Tone.Transport.scheduleOnce(async () => {
                    new Tone.Synth().toDestination().triggerAttackRelease("C5", "0.5");
                    dialMsg.textContent = "CONECTADO.";
                    resolve();
                }, "3.5");
                
                Tone.Transport.start();
            });
        }

        async function handleCommand() {
            const fullCommand = inputField.value.trim();
            if (fullCommand === '') return;

            const commandElement = document.createElement('p');
            commandElement.textContent = `${promptSymbol.textContent} ${fullCommand}`;
            terminalOutput.appendChild(commandElement);
            
            inputField.value = '';
            inputLine.style.display = 'none';

            const [command, ...args] = fullCommand.toLowerCase().split(' ');

            let output = '';
            if (commands[command]) {
                output = commands[command].execute(args);
            } else {
                output = `Sombra: comando não encontrado: ${command}`;
            }

            if (output) {
                const responseElement = document.createElement('p');
                responseElement.className = "text-green-400 my-2";
                terminalOutput.appendChild(responseElement);
                await typeWriter(output, responseElement);
            }
            
            inputLine.style.display = 'flex';
            terminal.scrollTop = terminal.scrollHeight;
            focusInput();
        }

        inputField.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                handleCommand();
            }
        });

        async function startTerminal() {
            for (const line of bootSequence) {
                const lineElement = document.createElement('p');
                terminalOutput.appendChild(lineElement);
                await typeWriter(line, lineElement, 20);
            }
            inputLine.style.display = 'flex';
            focusInput();
        }
        
        async function initiateConnection() {
            if (isAudioStarted) {
                focusInput();
                return;
            }
            isAudioStarted = true;
            
            terminalOutput.innerHTML = ''; 
            await Tone.start();

            typeSound = new Tone.MembraneSynth({
                pitchDecay: 0.008,
                octaves: 2,
                envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.01 },
            }).toDestination();
            typeSound.volume.value = -25;

            await playDialUpSound();
            await startTerminal();
        }

        window.onload = async () => {
            const initialMsg = document.createElement('p');
            terminalOutput.appendChild(initialMsg);
            await typeWriterSilent("CLIQUE PARA INICIAR CONEXÃO...", initialMsg, 50);
        };

    </script>
</body>
</html>
